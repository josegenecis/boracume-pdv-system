
// Endpoints das Sefaz por UF para NFC-e
export const SEFAZ_ENDPOINTS = {
  // Produção
  production: {
    'AC': 'https://nfce.sefaznet.ac.gov.br/nfce/services/NfceRecepcao',
    'AL': 'https://nfce.sefaz.al.gov.br/nfce/services/NfceRecepcao',
    'AP': 'https://nfce.sefaz.ap.gov.br/nfce/services/NfceRecepcao',
    'AM': 'https://nfce.sefaz.am.gov.br/nfce/services/NfceRecepcao',
    'BA': 'https://nfce.sefaz.ba.gov.br/nfce/services/NfceRecepcao',
    'CE': 'https://nfce.sefaz.ce.gov.br/nfce/services/NfceRecepcao',
    'DF': 'https://nfce.fazenda.df.gov.br/nfce/services/NfceRecepcao',
    'ES': 'https://nfce.sefaz.es.gov.br/nfce/services/NfceRecepcao',
    'GO': 'https://nfce.sefaz.go.gov.br/nfce/services/NfceRecepcao',
    'MA': 'https://nfce.sefaz.ma.gov.br/nfce/services/NfceRecepcao',
    'MT': 'https://nfce.sefaz.mt.gov.br/nfce/services/NfceRecepcao',
    'MS': 'https://nfce.sefaz.ms.gov.br/nfce/services/NfceRecepcao',
    'MG': 'https://nfce.fazenda.mg.gov.br/nfce/services/NfceRecepcao',
    'PA': 'https://nfce.sefa.pa.gov.br/nfce/services/NfceRecepcao',
    'PB': 'https://nfce.receita.pb.gov.br/nfce/services/NfceRecepcao',
    'PR': 'https://nfce.fazenda.pr.gov.br/nfce/services/NfceRecepcao',
    'PE': 'https://nfce.sefaz.pe.gov.br/nfce/services/NfceRecepcao',
    'PI': 'https://nfce.sefaz.pi.gov.br/nfce/services/NfceRecepcao',
    'RJ': 'https://nfce.fazenda.rj.gov.br/nfce/services/NfceRecepcao',
    'RN': 'https://nfce.set.rn.gov.br/nfce/services/NfceRecepcao',
    'RS': 'https://nfce.sefazrs.rs.gov.br/nfce/services/NfceRecepcao',
    'RO': 'https://nfce.sefin.ro.gov.br/nfce/services/NfceRecepcao',
    'RR': 'https://nfce.sefaz.rr.gov.br/nfce/services/NfceRecepcao',
    'SC': 'https://nfce.sef.sc.gov.br/nfce/services/NfceRecepcao',
    'SP': 'https://nfce.fazenda.sp.gov.br/nfce/services/NfceRecepcao',
    'SE': 'https://nfce.sefaz.se.gov.br/nfce/services/NfceRecepcao',
    'TO': 'https://nfce.sefaz.to.gov.br/nfce/services/NfceRecepcao'
  },
  // Homologação
  homologacao: {
    'AC': 'https://hom-nfce.sefaznet.ac.gov.br/nfce/services/NfceRecepcao',
    'AL': 'https://hom-nfce.sefaz.al.gov.br/nfce/services/NfceRecepcao',
    'AP': 'https://hom-nfce.sefaz.ap.gov.br/nfce/services/NfceRecepcao',
    'AM': 'https://hom-nfce.sefaz.am.gov.br/nfce/services/NfceRecepcao',
    'BA': 'https://hom-nfce.sefaz.ba.gov.br/nfce/services/NfceRecepcao',
    'CE': 'https://hom-nfce.sefaz.ce.gov.br/nfce/services/NfceRecepcao',
    'DF': 'https://hom-nfce.fazenda.df.gov.br/nfce/services/NfceRecepcao',
    'ES': 'https://hom-nfce.sefaz.es.gov.br/nfce/services/NfceRecepcao',
    'GO': 'https://hom-nfce.sefaz.go.gov.br/nfce/services/NfceRecepcao',
    'MA': 'https://hom-nfce.sefaz.ma.gov.br/nfce/services/NfceRecepcao',
    'MT': 'https://hom-nfce.sefaz.mt.gov.br/nfce/services/NfceRecepcao',
    'MS': 'https://hom-nfce.sefaz.ms.gov.br/nfce/services/NfceRecepcao',
    'MG': 'https://hom-nfce.fazenda.mg.gov.br/nfce/services/NfceRecepcao',
    'PA': 'https://hom-nfce.sefa.pa.gov.br/nfce/services/NfceRecepcao',
    'PB': 'https://hom-nfce.receita.pb.gov.br/nfce/services/NfceRecepcao',
    'PR': 'https://hom-nfce.fazenda.pr.gov.br/nfce/services/NfceRecepcao',
    'PE': 'https://hom-nfce.sefaz.pe.gov.br/nfce/services/NfceRecepcao',
    'PI': 'https://hom-nfce.sefaz.pi.gov.br/nfce/services/NfceRecepcao',
    'RJ': 'https://hom-nfce.fazenda.rj.gov.br/nfce/services/NfceRecepcao',
    'RN': 'https://hom-nfce.set.rn.gov.br/nfce/services/NfceRecepcao',
    'RS': 'https://hom-nfce.sefazrs.rs.gov.br/nfce/services/NfceRecepcao',
    'RO': 'https://hom-nfce.sefin.ro.gov.br/nfce/services/NfceRecepcao',
    'RR': 'https://hom-nfce.sefaz.rr.gov.br/nfce/services/NfceRecepcao',
    'SC': 'https://hom-nfce.sef.sc.gov.br/nfce/services/NfceRecepcao',
    'SP': 'https://hom-nfce.fazenda.sp.gov.br/nfce/services/NfceRecepcao',
    'SE': 'https://hom-nfce.sefaz.se.gov.br/nfce/services/NfceRecepcao',
    'TO': 'https://hom-nfce.sefaz.to.gov.br/nfce/services/NfceRecepcao'
  }
};

export function getSefazEndpoint(uf: string, ambiente: 'producao' | 'homologacao'): string {
  const endpoints = SEFAZ_ENDPOINTS[ambiente === 'producao' ? 'production' : 'homologacao'];
  return endpoints[uf as keyof typeof endpoints] || endpoints['SP']; // Fallback para SP
}

export interface SefazResponse {
  success: boolean;
  cStat: string;
  xMotivo: string;
  protocolo?: string;
  xmlRetorno: string;
  chaveAcesso?: string;
}

export function parseSefazResponse(xmlResponse: string): SefazResponse {
  try {
    // Parse básico do XML de retorno da Sefaz
    const cStatMatch = xmlResponse.match(/<cStat>(\d+)<\/cStat>/);
    const xMotivoMatch = xmlResponse.match(/<xMotivo>([^<]+)<\/xMotivo>/);
    const protocoloMatch = xmlResponse.match(/<nProt>([^<]+)<\/nProt>/);
    const chaveMatch = xmlResponse.match(/<chNFe>([^<]+)<\/chNFe>/);
    
    const cStat = cStatMatch ? cStatMatch[1] : '999';
    const xMotivo = xMotivoMatch ? xMotivoMatch[1] : 'Erro desconhecido';
    const protocolo = protocoloMatch ? protocoloMatch[1] : undefined;
    const chaveAcesso = chaveMatch ? chaveMatch[1] : undefined;
    
    return {
      success: cStat === '100' || cStat === '150', // 100 = Autorizado, 150 = Autorizado fora do prazo
      cStat,
      xMotivo,
      protocolo,
      xmlRetorno: xmlResponse,
      chaveAcesso
    };
  } catch (error) {
    return {
      success: false,
      cStat: '999',
      xMotivo: 'Erro ao processar resposta da Sefaz',
      xmlRetorno: xmlResponse
    };
  }
}
